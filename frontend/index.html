<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>PS-WS - Slice Manager</title>
    <style>
      :root {
        --border: #000000;
        --bg-light: #ffffff;
        --text: #000000;
        --text-secondary: #666666;
        --header-height: 60px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: monospace;
        color: var(--text);
        background: white;
        line-height: 1.5;
      }

      .header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: var(--header-height);
        background: white;
        border-bottom: 2px solid var(--border);
        display: flex;
        align-items: center;
        padding: 0 1.5rem;
        z-index: 100;
      }

      .logo {
        font-size: 1.25rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .main-container {
        display: flex;
        min-height: 100vh;
        padding-top: var(--header-height);
      }

      .content {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }

      .status {
        position: fixed;
        top: calc(var(--header-height) + 1rem);
        left: 50%;
        transform: translateX(-50%);
        padding: 0.5rem 1rem;
        border: 2px solid var(--border);
        font-size: 0.875rem;
        background: white;
        z-index: 10;
      }

      .status.connected {
        border-style: dashed;
      }

      .status.disconnected {
        border-style: solid;
      }

      .get-started-box {
        background: white;
        text-align: center;
        max-width: 500px;
        width: 100%;
      }

      .empty-state {
        background: white;
        text-align: center;
        max-width: 500px;
        width: 100%;
      }

      .empty-state-icon {
        width: 120px;
        height: 120px;
        margin: 0 auto 2rem;
      }

      .empty-state-title {
        font-size: 2rem;
        margin-bottom: 1rem;
        font-weight: bold;
      }

      .empty-state-text {
        color: var(--text-secondary);
        margin-bottom: 2rem;
        font-size: 1rem;
        line-height: 1.6;
      }

      .empty-state-button {
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 2rem;
        font-size: 1rem;
        border: 2px solid var(--border);
      }

      .empty-state-button:hover {
        background: black;
        color: white;
      }

      .slices-view {
        width: 100%;
        max-width: 800px;
        padding: 2rem;
      }

      .create-slice {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .create-slice input {
        flex: 1;
        padding: 0.5rem 1rem;
        border: 2px solid var(--border);
        font-size: 0.875rem;
        font-family: monospace;
      }

      .create-slice input:focus {
        outline: none;
        background: #f8f8f8;
      }

      .slices-list {
        list-style: none;
      }

      .slice-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border);
        margin-bottom: 0.5rem;
      }

      .slice-name {
        font-weight: bold;
        font-size: 0.875rem;
      }

      .command-box {
        background: var(--bg-light);
        border: 2px solid var(--border);
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        margin: 2rem 0;
        text-align: left;
      }

      #sessionCommand {
        font-family: monospace;
        font-size: 1rem;
        color: var(--text);
        flex-grow: 1;
      }

      button {
        background: white;
        color: black;
        border: 2px solid var(--border);
        padding: 0.5rem 1rem;
        font-weight: bold;
        cursor: pointer;
        font-family: monospace;
        font-size: 0.875rem;
      }

      button:hover {
        background: black;
        color: white;
      }

      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="logo">
        <span>üõ†Ô∏è</span>
        <span>Slice Manager</span>
      </div>
    </header>

    <div id="connectionStatus" class="status disconnected">
      Waiting for connection...
    </div>

    <div class="main-container">
      <main class="content">
        <!-- Get Started View -->
        <div id="getStartedView" class="get-started-box">
          <h3>
            <span>üöÄ</span>
            <span>Get Started</span>
          </h3>
          <p>Run this command in your project directory:</p>
          <div class="command-box">
            <code id="sessionCommand">npx ps-ws-cli session=waiting...</code>
            <button onclick="copyCommand()" class="copy-button">Copy</button>
          </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state hidden">
          <img
            src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHJlY3Qgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxMjAiIGZpbGw9IndoaXRlIi8+CiAgPHJlY3QgeD0iMjAiIHk9IjIwIiB3aWR0aD0iODAiIGhlaWdodD0iODAiIHN0cm9rZT0iYmxhY2siIHN0cm9rZS13aWR0aD0iNCIvPgogIDxsaW5lIHgxPSI0MCIgeTE9IjYwIiB4Mj0iODAiIHkyPSI2MCIgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgPGxpbmUgeDE9IjYwIiB5MT0iNDAiIHgyPSI2MCIgeTI9IjgwIiBzdHJva2U9ImJsYWNrIiBzdHJva2Utd2lkdGg9IjQiLz4KPC9zdmc+"
            class="empty-state-icon"
            alt="Empty box"
          />
          <h2 class="empty-state-title">Welcome to Slice Manager</h2>
          <p class="empty-state-text">
            Get started by creating your first slice. Slices help you organize
            and manage your project components.
          </p>
          <button class="empty-state-button" onclick="focusCreateInput()">
            <span>+</span>
            <span>Create your first slice</span>
          </button>
        </div>

        <!-- Slices View -->
        <div id="slicesView" class="slices-view hidden">
          <h2>Slices</h2>
          <div class="create-slice">
            <input
              type="text"
              id="sliceName"
              placeholder="Enter slice name..."
              autocomplete="off"
            />
            <button onclick="createSlice()">Create Slice</button>
          </div>
          <ul id="slicesList" class="slices-list"></ul>
        </div>
      </main>
    </div>

    <script>
      const STORAGE_KEY = "ps-ws-sessionId";
      let sessionId = localStorage.getItem(STORAGE_KEY);

      // Only generate a new ID if one doesn't exist
      if (!sessionId) {
        sessionId = Math.random().toString(36).substring(2, 15);
        localStorage.setItem(STORAGE_KEY, sessionId);
      }

      document.getElementById("sessionCommand").textContent =
        `npx ps-ws-cli session=${sessionId}`;

      // When disconnecting, we keep the same session ID
      const status = document.getElementById("connectionStatus");
      const getStartedView = document.getElementById("getStartedView");
      const emptyState = document.getElementById("emptyState");
      const slicesView = document.getElementById("slicesView");

      let ws;

      function connect() {
        ws = new WebSocket("wss://ps-ws-backend.fly.dev");

        ws.onopen = () => {
          // Use the same session ID when reconnecting
          ws.send(
            JSON.stringify({
              type: "register",
              role: "client",
              sessionId: localStorage.getItem(STORAGE_KEY),
            })
          );
          status.textContent = "Connected to server, waiting for agent...";
          status.className = "status disconnected";
        };

        ws.onclose = () => {
          status.textContent = "Disconnected from server, reconnecting...";
          status.className = "status disconnected";
          showView("getStarted");
          setTimeout(connect, 1000);
        };

        ws.onerror = () => {
          status.textContent = "Connection error, retrying...";
          status.className = "status disconnected";
        };

        ws.onmessage = (e) => {
          try {
            const data = JSON.parse(e.data);

            if (data.status === "connected") {
              if (data.role === "agent" && data.sessionId === sessionId) {
                status.textContent = "Connected to project";
                status.className = "status connected";
                showView("empty");
                updateSlicesList();
              }
            } else if (data.slices) {
              updateSlicesView(data.slices);
            } else if (
              data.status === "ok" &&
              data.message &&
              data.message.includes("deleted")
            ) {
              updateSlicesList();
            }
          } catch (error) {
            console.error("Error processing message:", error);
          }
        };
      }

      function showView(view) {
        getStartedView.classList.add("hidden");
        emptyState.classList.add("hidden");
        slicesView.classList.add("hidden");

        switch (view) {
          case "getStarted":
            getStartedView.classList.remove("hidden");
            break;
          case "empty":
            emptyState.classList.remove("hidden");
            break;
          case "slices":
            slicesView.classList.remove("hidden");
            break;
        }
      }

      function updateSlicesView(slices) {
        if (!slices || slices.length === 0) {
          showView("empty");
          return;
        }

        showView("slices");
        const slicesList = document.getElementById("slicesList");
        slicesList.innerHTML = slices
          .map(
            (slice) => `
            <li class="slice-item">
              <span class="slice-name">${slice.name}</span>
              <button class="delete" onclick="deleteSlice('${slice.name}')">Delete</button>
            </li>
          `
          )
          .join("");
      }

      function updateSlicesList() {
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(
            JSON.stringify({
              type: "list-slices",
              sessionId: localStorage.getItem(STORAGE_KEY),
            })
          );
        }
      }

      function createSlice() {
        const name = document.getElementById("sliceName").value.trim();
        if (!name) return;

        if (ws.readyState === WebSocket.OPEN) {
          ws.send(
            JSON.stringify({
              type: "create-slice",
              name,
              sessionId: localStorage.getItem(STORAGE_KEY),
            })
          );
          document.getElementById("sliceName").value = "";
          updateSlicesList();
        }
      }

      function deleteSlice(name) {
        if (confirm(`Are you sure you want to delete the slice "${name}"?`)) {
          if (ws.readyState === WebSocket.OPEN) {
            ws.send(
              JSON.stringify({
                type: "delete-slice",
                name,
                sessionId: localStorage.getItem(STORAGE_KEY),
              })
            );
          }
        }
      }

      function copyCommand() {
        const command = document.getElementById("sessionCommand").textContent;
        navigator.clipboard.writeText(command).then(() => {
          const button = document.querySelector(".copy-button");
          button.textContent = "Copied!";
          setTimeout(() => {
            button.textContent = "Copy";
          }, 2000);
        });
      }

      function focusCreateInput() {
        showView("slices");
        setTimeout(() => {
          document.getElementById("sliceName").focus();
        }, 0);
      }

      document.getElementById("sliceName").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          createSlice();
        }
      });

      connect();
    </script>
  </body>
</html>
